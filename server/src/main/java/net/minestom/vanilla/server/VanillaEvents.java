package net.minestom.vanilla.server;

import net.minestom.server.MinecraftServer;
import net.minestom.server.coordinate.Point;
import net.minestom.server.coordinate.Pos;
import net.minestom.server.coordinate.Vec;
import net.minestom.server.entity.Entity;
import net.minestom.server.entity.GameMode;
import net.minestom.server.entity.ItemEntity;
import net.minestom.server.entity.Player;
import net.minestom.server.event.Event;
import net.minestom.server.event.EventListener;
import net.minestom.server.event.EventNode;
import net.minestom.server.event.instance.AddEntityToInstanceEvent;
import net.minestom.server.event.item.ItemDropEvent;
import net.minestom.server.event.item.PickupItemEvent;
import net.minestom.server.event.player.*;
import net.minestom.server.extras.MojangAuth;
import net.minestom.server.instance.ExplosionSupplier;
import net.minestom.server.instance.Instance;
import net.minestom.server.inventory.PlayerInventory;
import net.minestom.server.item.ItemStack;
import net.minestom.server.item.Material;
import net.minestom.server.network.ConnectionManager;
import net.minestom.server.network.NetworkBuffer;
import net.minestom.server.network.packet.client.ClientPacket;
import net.minestom.server.network.packet.client.play.ClientPlayerPositionAndRotationPacket;
import net.minestom.server.network.packet.client.play.ClientPlayerPositionPacket;
import net.minestom.server.network.packet.client.play.ClientPlayerRotationPacket;
import net.minestom.server.network.packet.server.ServerPacket;
import net.minestom.server.network.packet.server.common.TagsPacket;
import net.minestom.server.network.packet.server.configuration.RegistryDataPacket;
import net.minestom.server.utils.PacketUtils;
import net.minestom.server.utils.time.TimeUnit;
import net.minestom.vanilla.datapack.DatapackLoadingFeature;
import net.minestom.vanilla.datapack.DatapackUtils;
import net.minestom.vanilla.files.ByteArray;
import net.minestom.vanilla.generation.VanillaTestGenerator;
import net.minestom.vanilla.instance.VanillaExplosion;
import net.minestom.vanilla.logging.Logger;
import net.minestom.vanilla.system.ServerProperties;
import org.jglrxavpok.hephaistos.nbt.*;
import org.jglrxavpok.hephaistos.parser.SNBTParser;

import java.io.*;
import java.nio.charset.StandardCharsets;
import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.Objects;

public class VanillaEvents {

    public static void register(VanillaServer server, ServerProperties properties, EventNode<Event> eventNode) {
        String worldName = properties.get("level-name");

        ExplosionSupplier explosionGenerator = (centerX, centerY, centerZ, strength, additionalData) -> {

            boolean isTNT = additionalData != null && Boolean.TRUE.equals(additionalData.get(VanillaExplosion.DROP_EVERYTHING_KEY));
            boolean noBlockDamage = additionalData != null && Boolean.TRUE.equals(additionalData.get(VanillaExplosion.DONT_DESTROY_BLOCKS_KEY));

            return VanillaExplosion.builder(new Pos(centerX, centerY, centerZ), strength)
                    .destroyBlocks(!noBlockDamage)
                    .isFlaming(false)
                    .dropEverything(isTNT)
                    .build();
        };
        final NBTCompound registries;
        try {
            registries = (NBTCompound) new SNBTParser(new StringReader(
                    "{\"minecraft:worldgen/biome\":{\"type\":\"minecraft:worldgen/biome\",\"value\":[{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"foliage_color\":10387789,\"water_color\":4159204,\"water_fog_color\":329011,\"grass_color\":9470285,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7254527,\"music\":{\"sound\":\"minecraft:music.overworld.badlands\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"fog_color\":12638463}},\"name\":\"minecraft:badlands\",\"id\":0},{\"element\":{\"has_precipitation\":1,\"downfall\":0.9D,\"temperature\":0.95D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7842047,\"music\":{\"sound\":\"minecraft:music.overworld.bamboo_jungle\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:bamboo_jungle\",\"id\":1},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"sky_color\":7254527,\"ambient_sound\":\"minecraft:ambient.basalt_deltas.loop\",\"fog_color\":6840176,\"mood_sound\":{\"sound\":\"minecraft:ambient.basalt_deltas.mood\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"additions_sound\":{\"sound\":\"minecraft:ambient.basalt_deltas.additions\",\"tick_chance\":0.0111D},\"water_color\":4159204,\"particle\":{\"options\":{\"type\":\"minecraft:white_ash\"},\"probability\":0.118093334D},\"music\":{\"sound\":\"minecraft:music.nether.basalt_deltas\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:basalt_deltas\",\"id\":2},{\"element\":{\"has_precipitation\":1,\"downfall\":0.4D,\"temperature\":0.8D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7907327,\"water_color\":4159204}},\"name\":\"minecraft:beach\",\"id\":3},{\"element\":{\"has_precipitation\":1,\"downfall\":0.6D,\"temperature\":0.6D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8037887,\"music\":{\"sound\":\"minecraft:music.overworld.forest\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:birch_forest\",\"id\":4},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.5D,\"effects\":{\"foliage_color\":11983713,\"water_color\":6141935,\"water_fog_color\":6141935,\"grass_color\":11983713,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"music\":{\"sound\":\"minecraft:music.overworld.cherry_grove\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"fog_color\":12638463}},\"name\":\"minecraft:cherry_grove\",\"id\":5},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4020182}},\"name\":\"minecraft:cold_ocean\",\"id\":6},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"sky_color\":7254527,\"ambient_sound\":\"minecraft:ambient.crimson_forest.loop\",\"fog_color\":3343107,\"mood_sound\":{\"sound\":\"minecraft:ambient.crimson_forest.mood\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"additions_sound\":{\"sound\":\"minecraft:ambient.crimson_forest.additions\",\"tick_chance\":0.0111D},\"water_color\":4159204,\"particle\":{\"options\":{\"type\":\"minecraft:crimson_spore\"},\"probability\":0.025D},\"music\":{\"sound\":\"minecraft:music.nether.crimson_forest\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:crimson_forest\",\"id\":7},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.7D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"grass_color_modifier\":\"dark_forest\",\"music\":{\"sound\":\"minecraft:music.overworld.forest\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011,\"sky_color\":7972607,\"fog_color\":12638463,\"water_color\":4159204}},\"name\":\"minecraft:dark_forest\",\"id\":8},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4020182}},\"name\":\"minecraft:deep_cold_ocean\",\"id\":9},{\"element\":{\"has_precipitation\":1,\"downfall\":0.4D,\"temperature\":0.8D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7907327,\"music\":{\"sound\":\"minecraft:music.overworld.deep_dark\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:deep_dark\",\"id\":10},{\"element\":{\"temperature_modifier\":\"frozen\",\"temperature\":0.5D,\"has_precipitation\":1,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":3750089},\"downfall\":0.5D},\"name\":\"minecraft:deep_frozen_ocean\",\"id\":11},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":267827,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4566514}},\"name\":\"minecraft:deep_lukewarm_ocean\",\"id\":12},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4159204}},\"name\":\"minecraft:deep_ocean\",\"id\":13},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7254527,\"music\":{\"sound\":\"minecraft:music.overworld.desert\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:desert\",\"id\":14},{\"element\":{\"has_precipitation\":1,\"downfall\":0.4D,\"temperature\":0.8D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7907327,\"music\":{\"sound\":\"minecraft:music.overworld.dripstone_caves\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:dripstone_caves\",\"id\":15},{\"element\":{\"has_precipitation\":0,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":10518688,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":0,\"water_color\":4159204}},\"name\":\"minecraft:end_barrens\",\"id\":16},{\"element\":{\"has_precipitation\":0,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":10518688,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":0,\"water_color\":4159204}},\"name\":\"minecraft:end_highlands\",\"id\":17},{\"element\":{\"has_precipitation\":0,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":10518688,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":0,\"water_color\":4159204}},\"name\":\"minecraft:end_midlands\",\"id\":18},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"foliage_color\":10387789,\"water_color\":4159204,\"water_fog_color\":329011,\"grass_color\":9470285,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7254527,\"music\":{\"sound\":\"minecraft:music.overworld.badlands\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"fog_color\":12638463}},\"name\":\"minecraft:eroded_badlands\",\"id\":19},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.7D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7972607,\"music\":{\"sound\":\"minecraft:music.overworld.flower_forest\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:flower_forest\",\"id\":20},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.7D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7972607,\"music\":{\"sound\":\"minecraft:music.overworld.forest\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:forest\",\"id\":21},{\"element\":{\"temperature_modifier\":\"frozen\",\"temperature\":0.0D,\"has_precipitation\":1,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8364543,\"water_color\":3750089},\"downfall\":0.5D},\"name\":\"minecraft:frozen_ocean\",\"id\":22},{\"element\":{\"has_precipitation\":1,\"downfall\":0.9D,\"temperature\":-0.7D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8756735,\"music\":{\"sound\":\"minecraft:music.overworld.frozen_peaks\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:frozen_peaks\",\"id\":23},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.0D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8364543,\"water_color\":3750089}},\"name\":\"minecraft:frozen_river\",\"id\":24},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":-0.2D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8495359,\"music\":{\"sound\":\"minecraft:music.overworld.grove\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:grove\",\"id\":25},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.0D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8364543,\"water_color\":4159204}},\"name\":\"minecraft:ice_spikes\",\"id\":26},{\"element\":{\"has_precipitation\":1,\"downfall\":0.9D,\"temperature\":-0.7D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8756735,\"music\":{\"sound\":\"minecraft:music.overworld.jagged_peaks\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:jagged_peaks\",\"id\":27},{\"element\":{\"has_precipitation\":1,\"downfall\":0.9D,\"temperature\":0.95D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7842047,\"music\":{\"sound\":\"minecraft:music.overworld.jungle\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:jungle\",\"id\":28},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":267827,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4566514}},\"name\":\"minecraft:lukewarm_ocean\",\"id\":29},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8103167,\"music\":{\"sound\":\"minecraft:music.overworld.lush_caves\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:lush_caves\",\"id\":30},{\"element\":{\"has_precipitation\":1,\"downfall\":0.9D,\"temperature\":0.8D,\"effects\":{\"foliage_color\":9285927,\"grass_color_modifier\":\"swamp\",\"water_color\":3832426,\"water_fog_color\":5077600,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7907327,\"music\":{\"sound\":\"minecraft:music.overworld.swamp\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"fog_color\":12638463}},\"name\":\"minecraft:mangrove_swamp\",\"id\":31},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.5D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":937679,\"fog_color\":12638463,\"sky_color\":8103167,\"music\":{\"sound\":\"minecraft:music.overworld.meadow\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:meadow\",\"id\":32},{\"element\":{\"has_precipitation\":1,\"downfall\":1.0D,\"temperature\":0.9D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7842047,\"water_color\":4159204}},\"name\":\"minecraft:mushroom_fields\",\"id\":33},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"water_color\":4159204,\"water_fog_color\":329011,\"mood_sound\":{\"sound\":\"minecraft:ambient.nether_wastes.mood\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"ambient_sound\":\"minecraft:ambient.nether_wastes.loop\",\"additions_sound\":{\"sound\":\"minecraft:ambient.nether_wastes.additions\",\"tick_chance\":0.0111D},\"sky_color\":7254527,\"music\":{\"sound\":\"minecraft:music.nether.nether_wastes\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"fog_color\":3344392}},\"name\":\"minecraft:nether_wastes\",\"id\":34},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4159204}},\"name\":\"minecraft:ocean\",\"id\":35},{\"element\":{\"has_precipitation\":1,\"downfall\":0.6D,\"temperature\":0.6D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8037887,\"music\":{\"sound\":\"minecraft:music.overworld.forest\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:old_growth_birch_forest\",\"id\":36},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.3D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8168447,\"music\":{\"sound\":\"minecraft:music.overworld.old_growth_taiga\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:old_growth_pine_taiga\",\"id\":37},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.25D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8233983,\"music\":{\"sound\":\"minecraft:music.overworld.old_growth_taiga\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:old_growth_spruce_taiga\",\"id\":38},{\"element\":{\"has_precipitation\":1,\"downfall\":0.4D,\"temperature\":0.8D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7907327,\"water_color\":4159204}},\"name\":\"minecraft:plains\",\"id\":39},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4159204}},\"name\":\"minecraft:river\",\"id\":40},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7254527,\"water_color\":4159204}},\"name\":\"minecraft:savanna\",\"id\":41},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7254527,\"water_color\":4159204}},\"name\":\"minecraft:savanna_plateau\",\"id\":42},{\"element\":{\"has_precipitation\":0,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":10518688,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":0,\"water_color\":4159204}},\"name\":\"minecraft:small_end_islands\",\"id\":43},{\"element\":{\"has_precipitation\":1,\"downfall\":0.3D,\"temperature\":0.05D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8364543,\"water_color\":4020182}},\"name\":\"minecraft:snowy_beach\",\"id\":44},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.0D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8364543,\"water_color\":4159204}},\"name\":\"minecraft:snowy_plains\",\"id\":45},{\"element\":{\"has_precipitation\":1,\"downfall\":0.9D,\"temperature\":-0.3D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":8560639,\"music\":{\"sound\":\"minecraft:music.overworld.snowy_slopes\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:snowy_slopes\",\"id\":46},{\"element\":{\"has_precipitation\":1,\"downfall\":0.4D,\"temperature\":-0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8625919,\"water_color\":4020182}},\"name\":\"minecraft:snowy_taiga\",\"id\":47},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"sky_color\":7254527,\"ambient_sound\":\"minecraft:ambient.soul_sand_valley.loop\",\"fog_color\":1787717,\"mood_sound\":{\"sound\":\"minecraft:ambient.soul_sand_valley.mood\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"additions_sound\":{\"sound\":\"minecraft:ambient.soul_sand_valley.additions\",\"tick_chance\":0.0111D},\"water_color\":4159204,\"particle\":{\"options\":{\"type\":\"minecraft:ash\"},\"probability\":0.00625D},\"music\":{\"sound\":\"minecraft:music.nether.soul_sand_valley\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:soul_sand_valley\",\"id\":48},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.95D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7842047,\"music\":{\"sound\":\"minecraft:music.overworld.sparse_jungle\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:sparse_jungle\",\"id\":49},{\"element\":{\"has_precipitation\":1,\"downfall\":0.3D,\"temperature\":1.0D,\"effects\":{\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"water_color\":4159204,\"fog_color\":12638463,\"sky_color\":7776511,\"music\":{\"sound\":\"minecraft:music.overworld.stony_peaks\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:stony_peaks\",\"id\":50},{\"element\":{\"has_precipitation\":1,\"downfall\":0.3D,\"temperature\":0.2D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8233727,\"water_color\":4159204}},\"name\":\"minecraft:stony_shore\",\"id\":51},{\"element\":{\"has_precipitation\":1,\"downfall\":0.4D,\"temperature\":0.8D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7907327,\"water_color\":4159204}},\"name\":\"minecraft:sunflower_plains\",\"id\":52},{\"element\":{\"has_precipitation\":1,\"downfall\":0.9D,\"temperature\":0.8D,\"effects\":{\"foliage_color\":6975545,\"grass_color_modifier\":\"swamp\",\"water_color\":6388580,\"water_fog_color\":2302743,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7907327,\"music\":{\"sound\":\"minecraft:music.overworld.swamp\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"fog_color\":12638463}},\"name\":\"minecraft:swamp\",\"id\":53},{\"element\":{\"has_precipitation\":1,\"downfall\":0.8D,\"temperature\":0.25D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8233983,\"water_color\":4159204}},\"name\":\"minecraft:taiga\",\"id\":54},{\"element\":{\"has_precipitation\":0,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":10518688,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":0,\"water_color\":4159204}},\"name\":\"minecraft:the_end\",\"id\":55},{\"element\":{\"has_precipitation\":0,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4159204}},\"name\":\"minecraft:the_void\",\"id\":56},{\"element\":{\"has_precipitation\":1,\"downfall\":0.5D,\"temperature\":0.5D,\"effects\":{\"water_fog_color\":270131,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8103167,\"water_color\":4445678}},\"name\":\"minecraft:warm_ocean\",\"id\":57},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"sky_color\":7254527,\"ambient_sound\":\"minecraft:ambient.warped_forest.loop\",\"fog_color\":1705242,\"mood_sound\":{\"sound\":\"minecraft:ambient.warped_forest.mood\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"additions_sound\":{\"sound\":\"minecraft:ambient.warped_forest.additions\",\"tick_chance\":0.0111D},\"water_color\":4159204,\"particle\":{\"options\":{\"type\":\"minecraft:warped_spore\"},\"probability\":0.01428D},\"music\":{\"sound\":\"minecraft:music.nether.warped_forest\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"water_fog_color\":329011}},\"name\":\"minecraft:warped_forest\",\"id\":58},{\"element\":{\"has_precipitation\":1,\"downfall\":0.3D,\"temperature\":0.2D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8233727,\"water_color\":4159204}},\"name\":\"minecraft:windswept_forest\",\"id\":59},{\"element\":{\"has_precipitation\":1,\"downfall\":0.3D,\"temperature\":0.2D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8233727,\"water_color\":4159204}},\"name\":\"minecraft:windswept_gravelly_hills\",\"id\":60},{\"element\":{\"has_precipitation\":1,\"downfall\":0.3D,\"temperature\":0.2D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":8233727,\"water_color\":4159204}},\"name\":\"minecraft:windswept_hills\",\"id\":61},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"water_fog_color\":329011,\"fog_color\":12638463,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7254527,\"water_color\":4159204}},\"name\":\"minecraft:windswept_savanna\",\"id\":62},{\"element\":{\"has_precipitation\":0,\"downfall\":0.0D,\"temperature\":2.0D,\"effects\":{\"foliage_color\":10387789,\"water_color\":4159204,\"water_fog_color\":329011,\"grass_color\":9470285,\"mood_sound\":{\"sound\":\"minecraft:ambient.cave\",\"offset\":2.0D,\"tick_delay\":6000,\"block_search_extent\":8},\"sky_color\":7254527,\"music\":{\"sound\":\"minecraft:music.overworld.badlands\",\"min_delay\":12000,\"replace_current_music\":0,\"max_delay\":24000},\"fog_color\":12638463}},\"name\":\"minecraft:wooded_badlands\",\"id\":63}]},\"minecraft:trim_material\":{\"type\":\"minecraft:trim_material\",\"value\":[{\"element\":{\"description\":{\"color\":\"#9A5CC6\",\"translate\":\"trim_material.minecraft.amethyst\"},\"asset_name\":\"amethyst\",\"ingredient\":\"minecraft:amethyst_shard\",\"item_model_index\":1.0D},\"name\":\"minecraft:amethyst\",\"id\":0},{\"element\":{\"description\":{\"color\":\"#B4684\",\"translate\":\"trim_material.minecraft.copper\"},\"asset_name\":\"copper\",\"ingredient\":\"minecraft:copper_ingot\",\"item_model_index\":0.5D},\"name\":\"minecraft:copper\",\"id\":1},{\"element\":{\"description\":{\"color\":\"#6EECD2\",\"translate\":\"trim_material.minecraft.diamond\"},\"ingredient\":\"minecraft:diamond\",\"item_model_index\":0.8D,\"asset_name\":\"diamond\",\"override_armor_materials\":{\"diamond\":\"diamond_darker\"}},\"name\":\"minecraft:diamond\",\"id\":2},{\"element\":{\"description\":{\"color\":\"#11A036\",\"translate\":\"trim_material.minecraft.emerald\"},\"asset_name\":\"emerald\",\"ingredient\":\"minecraft:emerald\",\"item_model_index\":0.7D},\"name\":\"minecraft:emerald\",\"id\":3},{\"element\":{\"description\":{\"color\":\"#DEB12\",\"translate\":\"trim_material.minecraft.gold\"},\"ingredient\":\"minecraft:gold_ingot\",\"item_model_index\":0.6D,\"asset_name\":\"gold\",\"override_armor_materials\":{\"gold\":\"gold_darker\"}},\"name\":\"minecraft:gold\",\"id\":4},{\"element\":{\"description\":{\"color\":\"#ECECEC\",\"translate\":\"trim_material.minecraft.iron\"},\"ingredient\":\"minecraft:iron_ingot\",\"item_model_index\":0.2D,\"asset_name\":\"iron\",\"override_armor_materials\":{\"iron\":\"iron_darker\"}},\"name\":\"minecraft:iron\",\"id\":5},{\"element\":{\"description\":{\"color\":\"#416E97\",\"translate\":\"trim_material.minecraft.lapis\"},\"asset_name\":\"lapis\",\"ingredient\":\"minecraft:lapis_lazuli\",\"item_model_index\":0.9D},\"name\":\"minecraft:lapis\",\"id\":6},{\"element\":{\"description\":{\"color\":\"#625859\",\"translate\":\"trim_material.minecraft.netherite\"},\"ingredient\":\"minecraft:netherite_ingot\",\"item_model_index\":0.3D,\"asset_name\":\"netherite\",\"override_armor_materials\":{\"netherite\":\"netherite_darker\"}},\"name\":\"minecraft:netherite\",\"id\":7},{\"element\":{\"description\":{\"color\":\"#E34C4\",\"translate\":\"trim_material.minecraft.quartz\"},\"asset_name\":\"quartz\",\"ingredient\":\"minecraft:quartz\",\"item_model_index\":0.1D},\"name\":\"minecraft:quartz\",\"id\":8},{\"element\":{\"description\":{\"color\":\"#971607\",\"translate\":\"trim_material.minecraft.redstone\"},\"asset_name\":\"redstone\",\"ingredient\":\"minecraft:redstone\",\"item_model_index\":0.4D},\"name\":\"minecraft:redstone\",\"id\":9}]},\"minecraft:damage_type\":{\"type\":\"minecraft:damage_type\",\"value\":[{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"arrow\"},\"name\":\"minecraft:arrow\",\"id\":0},{\"element\":{\"scaling\":\"always\",\"exhaustion\":0.1D,\"death_message_type\":\"intentional_game_design\",\"message_id\":\"badRespawnPoint\"},\"name\":\"minecraft:bad_respawn_point\",\"id\":1},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"cactus\"},\"name\":\"minecraft:cactus\",\"id\":2},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"cramming\"},\"name\":\"minecraft:cramming\",\"id\":3},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"dragonBreath\"},\"name\":\"minecraft:dragon_breath\",\"id\":4},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"drown\",\"effects\":\"drowning\"},\"name\":\"minecraft:drown\",\"id\":5},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"dryout\"},\"name\":\"minecraft:dry_out\",\"id\":6},{\"element\":{\"scaling\":\"always\",\"exhaustion\":0.1D,\"message_id\":\"explosion\"},\"name\":\"minecraft:explosion\",\"id\":7},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"death_message_type\":\"fall_variants\",\"message_id\":\"fall\"},\"name\":\"minecraft:fall\",\"id\":8},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"anvil\"},\"name\":\"minecraft:falling_anvil\",\"id\":9},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"fallingBlock\"},\"name\":\"minecraft:falling_block\",\"id\":10},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"fallingStalactite\"},\"name\":\"minecraft:falling_stalactite\",\"id\":11},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"fireball\",\"effects\":\"burning\"},\"name\":\"minecraft:fireball\",\"id\":12},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"fireworks\"},\"name\":\"minecraft:fireworks\",\"id\":13},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"flyIntoWall\"},\"name\":\"minecraft:fly_into_wall\",\"id\":14},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"freeze\",\"effects\":\"freezing\"},\"name\":\"minecraft:freeze\",\"id\":15},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"generic\"},\"name\":\"minecraft:generic\",\"id\":16},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"genericKill\"},\"name\":\"minecraft:generic_kill\",\"id\":17},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"hotFloor\",\"effects\":\"burning\"},\"name\":\"minecraft:hot_floor\",\"id\":18},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"inFire\",\"effects\":\"burning\"},\"name\":\"minecraft:in_fire\",\"id\":19},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"inWall\"},\"name\":\"minecraft:in_wall\",\"id\":20},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"indirectMagic\"},\"name\":\"minecraft:indirect_magic\",\"id\":21},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"lava\",\"effects\":\"burning\"},\"name\":\"minecraft:lava\",\"id\":22},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"lightningBolt\"},\"name\":\"minecraft:lightning_bolt\",\"id\":23},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"magic\"},\"name\":\"minecraft:magic\",\"id\":24},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"mob\"},\"name\":\"minecraft:mob_attack\",\"id\":25},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"mob\"},\"name\":\"minecraft:mob_attack_no_aggro\",\"id\":26},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"mob\"},\"name\":\"minecraft:mob_projectile\",\"id\":27},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"onFire\",\"effects\":\"burning\"},\"name\":\"minecraft:on_fire\",\"id\":28},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"outOfWorld\"},\"name\":\"minecraft:out_of_world\",\"id\":29},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"outsideBorder\"},\"name\":\"minecraft:outside_border\",\"id\":30},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"player\"},\"name\":\"minecraft:player_attack\",\"id\":31},{\"element\":{\"scaling\":\"always\",\"exhaustion\":0.1D,\"message_id\":\"explosion.player\"},\"name\":\"minecraft:player_explosion\",\"id\":32},{\"element\":{\"scaling\":\"always\",\"exhaustion\":0.0D,\"message_id\":\"sonic_boom\"},\"name\":\"minecraft:sonic_boom\",\"id\":33},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"stalagmite\"},\"name\":\"minecraft:stalagmite\",\"id\":34},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"starve\"},\"name\":\"minecraft:starve\",\"id\":35},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"sting\"},\"name\":\"minecraft:sting\",\"id\":36},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"sweetBerryBush\",\"effects\":\"poking\"},\"name\":\"minecraft:sweet_berry_bush\",\"id\":37},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"thorns\",\"effects\":\"thorns\"},\"name\":\"minecraft:thorns\",\"id\":38},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"thrown\"},\"name\":\"minecraft:thrown\",\"id\":39},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"trident\"},\"name\":\"minecraft:trident\",\"id\":40},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"onFire\",\"effects\":\"burning\"},\"name\":\"minecraft:unattributed_fireball\",\"id\":41},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.0D,\"message_id\":\"wither\"},\"name\":\"minecraft:wither\",\"id\":42},{\"element\":{\"scaling\":\"when_caused_by_living_non_player\",\"exhaustion\":0.1D,\"message_id\":\"witherSkull\"},\"name\":\"minecraft:wither_skull\",\"id\":43}]},\"minecraft:dimension_type\":{\"type\":\"minecraft:dimension_type\",\"value\":[{\"element\":{\"effects\":\"minecraft:overworld\",\"ultrawarm\":0,\"height\":384,\"ambient_light\":0.0D,\"has_raids\":1,\"infiniburn\":\"#minecraft:infiniburn_overworld\",\"min_y\":-64,\"respawn_anchor_works\":0,\"bed_works\":1,\"logical_height\":384,\"coordinate_scale\":1.0D,\"natural\":1,\"piglin_safe\":0,\"has_ceiling\":0,\"has_skylight\":1,\"monster_spawn_light_level\":{\"type\":\"minecraft:uniform\",\"value\":{\"min_inclusive\":0,\"max_inclusive\":7}},\"monster_spawn_block_light_limit\":0},\"name\":\"minecraft:overworld\",\"id\":0},{\"element\":{\"effects\":\"minecraft:overworld\",\"ultrawarm\":0,\"height\":384,\"ambient_light\":0.0D,\"has_raids\":1,\"infiniburn\":\"#minecraft:infiniburn_overworld\",\"min_y\":-64,\"respawn_anchor_works\":0,\"bed_works\":1,\"logical_height\":384,\"coordinate_scale\":1.0D,\"natural\":1,\"piglin_safe\":0,\"has_ceiling\":1,\"has_skylight\":1,\"monster_spawn_light_level\":{\"type\":\"minecraft:uniform\",\"value\":{\"min_inclusive\":0,\"max_inclusive\":7}},\"monster_spawn_block_light_limit\":0},\"name\":\"minecraft:overworld_caves\",\"id\":1},{\"element\":{\"ultrawarm\":0,\"piglin_safe\":0,\"has_ceiling\":0,\"coordinate_scale\":1.0D,\"bed_works\":0,\"ambient_light\":0.0D,\"monster_spawn_light_level\":{\"type\":\"minecraft:uniform\",\"value\":{\"min_inclusive\":0,\"max_inclusive\":7}},\"natural\":0,\"has_skylight\":0,\"has_raids\":1,\"monster_spawn_block_light_limit\":0,\"fixed_time\":6000,\"respawn_anchor_works\":0,\"infiniburn\":\"#minecraft:infiniburn_end\",\"min_y\":0,\"height\":256,\"effects\":\"minecraft:the_end\",\"logical_height\":256},\"name\":\"minecraft:the_end\",\"id\":2},{\"element\":{\"ultrawarm\":1,\"piglin_safe\":1,\"has_ceiling\":1,\"coordinate_scale\":8.0D,\"bed_works\":0,\"ambient_light\":0.1D,\"monster_spawn_light_level\":7,\"natural\":0,\"has_skylight\":0,\"has_raids\":0,\"monster_spawn_block_light_limit\":15,\"fixed_time\":18000,\"respawn_anchor_works\":1,\"infiniburn\":\"#minecraft:infiniburn_nether\",\"min_y\":0,\"height\":256,\"effects\":\"minecraft:the_nether\",\"logical_height\":128},\"name\":\"minecraft:the_nether\",\"id\":3}]},\"minecraft:chat_type\":{\"type\":\"minecraft:chat_type\",\"value\":[{\"element\":{\"narration\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.text.narrate\"},\"chat\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.text\"}},\"name\":\"minecraft:chat\",\"id\":0},{\"element\":{\"narration\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.emote\"},\"chat\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.emote\"}},\"name\":\"minecraft:emote_command\",\"id\":1},{\"element\":{\"narration\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.text.narrate\"},\"chat\":{\"parameters\":[\"sender\",\"content\"],\"style\":{\"color\":\"gray\",\"italic\":1},\"translation_key\":\"commands.message.display.incoming\"}},\"name\":\"minecraft:msg_command_incoming\",\"id\":2},{\"element\":{\"narration\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.text.narrate\"},\"chat\":{\"parameters\":[\"target\",\"content\"],\"style\":{\"color\":\"gray\",\"italic\":1},\"translation_key\":\"commands.message.display.outgoing\"}},\"name\":\"minecraft:msg_command_outgoing\",\"id\":3},{\"element\":{\"narration\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.text.narrate\"},\"chat\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.announcement\"}},\"name\":\"minecraft:say_command\",\"id\":4},{\"element\":{\"narration\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.text.narrate\"},\"chat\":{\"parameters\":[\"target\",\"sender\",\"content\"],\"translation_key\":\"chat.type.team.text\"}},\"name\":\"minecraft:team_msg_command_incoming\",\"id\":5},{\"element\":{\"narration\":{\"parameters\":[\"sender\",\"content\"],\"translation_key\":\"chat.type.text.narrate\"},\"chat\":{\"parameters\":[\"target\",\"sender\",\"content\"],\"translation_key\":\"chat.type.team.sent\"}},\"name\":\"minecraft:team_msg_command_outgoing\",\"id\":6}]},\"minecraft:trim_pattern\":{\"type\":\"minecraft:trim_pattern\",\"value\":[{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.coast\"},\"asset_id\":\"minecraft:coast\",\"template_item\":\"minecraft:coast_armor_trim_smithing_template\"},\"name\":\"minecraft:coast\",\"id\":0},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.dune\"},\"asset_id\":\"minecraft:dune\",\"template_item\":\"minecraft:dune_armor_trim_smithing_template\"},\"name\":\"minecraft:dune\",\"id\":1},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.eye\"},\"asset_id\":\"minecraft:eye\",\"template_item\":\"minecraft:eye_armor_trim_smithing_template\"},\"name\":\"minecraft:eye\",\"id\":2},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.host\"},\"asset_id\":\"minecraft:host\",\"template_item\":\"minecraft:host_armor_trim_smithing_template\"},\"name\":\"minecraft:host\",\"id\":3},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.raiser\"},\"asset_id\":\"minecraft:raiser\",\"template_item\":\"minecraft:raiser_armor_trim_smithing_template\"},\"name\":\"minecraft:raiser\",\"id\":4},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.rib\"},\"asset_id\":\"minecraft:rib\",\"template_item\":\"minecraft:rib_armor_trim_smithing_template\"},\"name\":\"minecraft:rib\",\"id\":5},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.sentry\"},\"asset_id\":\"minecraft:sentry\",\"template_item\":\"minecraft:sentry_armor_trim_smithing_template\"},\"name\":\"minecraft:sentry\",\"id\":6},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.shaper\"},\"asset_id\":\"minecraft:shaper\",\"template_item\":\"minecraft:shaper_armor_trim_smithing_template\"},\"name\":\"minecraft:shaper\",\"id\":7},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.silence\"},\"asset_id\":\"minecraft:silence\",\"template_item\":\"minecraft:silence_armor_trim_smithing_template\"},\"name\":\"minecraft:silence\",\"id\":8},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.snout\"},\"asset_id\":\"minecraft:snout\",\"template_item\":\"minecraft:snout_armor_trim_smithing_template\"},\"name\":\"minecraft:snout\",\"id\":9},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.spire\"},\"asset_id\":\"minecraft:spire\",\"template_item\":\"minecraft:spire_armor_trim_smithing_template\"},\"name\":\"minecraft:spire\",\"id\":10},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.tide\"},\"asset_id\":\"minecraft:tide\",\"template_item\":\"minecraft:tide_armor_trim_smithing_template\"},\"name\":\"minecraft:tide\",\"id\":11},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.vex\"},\"asset_id\":\"minecraft:vex\",\"template_item\":\"minecraft:vex_armor_trim_smithing_template\"},\"name\":\"minecraft:vex\",\"id\":12},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.ward\"},\"asset_id\":\"minecraft:ward\",\"template_item\":\"minecraft:ward_armor_trim_smithing_template\"},\"name\":\"minecraft:ward\",\"id\":13},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.wayfinder\"},\"asset_id\":\"minecraft:wayfinder\",\"template_item\":\"minecraft:wayfinder_armor_trim_smithing_template\"},\"name\":\"minecraft:wayfinder\",\"id\":14},{\"element\":{\"decal\":0,\"description\":{\"translate\":\"trim_pattern.minecraft.wild\"},\"asset_id\":\"minecraft:wild\",\"template_item\":\"minecraft:wild_armor_trim_smithing_template\"},\"name\":\"minecraft:wild\",\"id\":15}]}}"
            )).parse();
        } catch (NBTException e) {
            throw new RuntimeException(e);
        }
//                NBT.Compound(Map.of(
//                "minecraft:trim_material", NBT.Compound(Map.of(
//                        "type",NBT.String("minecraft:trim_material"),
//                        "value", NBT.List(NBTType.TAG_Compound, DatapackUtils.getTrimMaterials(server.vri().feature(DatapackLoadingFeature.class).current()))
//                )),
//                "minecraft:trim_pattern", NBT.Compound(Map.of(
//                        "type",NBT.String("minecraft:trim_pattern"),
//                        "value", NBT.List(NBTType.TAG_Compound,DatapackUtils.getTrimPatterns(server.vri().feature(DatapackLoadingFeature.class).current()))
//                ))
//        ));
        // TODO: World storage

        VanillaTestGenerator noiseTestGenerator = new VanillaTestGenerator();
        Instance overworld = server.overworld();
//        overworld.enableAutoChunkLoad(true);
//        overworld.setGenerator(noiseTestGenerator);
//        overworld.setExplosionSupplier(explosionGenerator);
//        overworld.setChunkLoader(new AnvilChunkLoader(storageManager.getLocation(worldName + "/region")));
//
//        nether = MinecraftServer.getInstanceManager().createInstanceContainer(VanillaDimensionTypes.NETHER);
//        nether.enableAutoChunkLoad(true);
//        nether.setGenerator(noiseTestGenerator);
//        nether.setExplosionSupplier(explosionGenerator);
//        nether.setChunkLoader(new AnvilChunkLoader(storageManager.getLocation(worldName + "/DIM-1/region")));
//
//        end = MinecraftServer.getInstanceManager().createInstanceContainer(VanillaDimensionTypes.END);
//        end.enableAutoChunkLoad(true);
//        end.setGenerator(noiseTestGenerator);
//        end.setExplosionSupplier(explosionGenerator);
//        end.setChunkLoader(new AnvilChunkLoader(storageManager.getLocation(worldName + "/DIM1/region")));

        // Load some chunks beforehand
        int loopStart = -2;
        int loopEnd = 2;
        for (int x = loopStart; x < loopEnd; x++)
            for (int z = loopStart; z < loopEnd; z++) {
                overworld.loadChunk(x, z);
            }


        eventNode.addListener(AddEntityToInstanceEvent.class, event -> {
            Entity entity = event.getEntity();

            if (entity instanceof Player) {
//                entity.setTag(NetherPortalBlockHandler.PORTAL_COOLDOWN_TIME_KEY, 5 * 20L);
            }
        });

        MinecraftServer.getSchedulerManager().buildShutdownTask(() -> {
            try {
                overworld.saveInstance();
            } catch (Throwable e) {
                e.printStackTrace();
            }
        });

        if (Boolean.parseBoolean(properties.get("online-mode"))) {
            MojangAuth.init();
        }

        ConnectionManager connectionManager = MinecraftServer.getConnectionManager();

        eventNode.addListener(
                EventListener.of(AsyncPlayerConfigurationEvent.class, event -> {
                    event.setSendRegistryData(false);
                    event.getPlayer().sendPacket(TagsPacket.DEFAULT_TAGS);
                    event.getPlayer().sendPacket(new RegistryDataPacket(registries));
                    event.setSpawningInstance(overworld);
                    Logger.info(event.getPlayer().getUsername() + " joined the server");
                })
        );

        eventNode.addListener(
                EventListener.of(PlayerDisconnectEvent.class, event -> {
                    Logger.info(event.getPlayer().getUsername() + " left the server");
                })
        );

        eventNode.addListener(
                PlayerPacketEvent.class,
                event -> {
                    ClientPacket packet = event.getPacket();
                    // moving around and keepalive packets aren't usually required
                    if (packet instanceof ClientPlayerPositionPacket) return;
                    if (packet instanceof ClientPlayerPositionAndRotationPacket) return;
                    if (packet instanceof ClientPlayerRotationPacket) return;
                    Logger.info("Packet received " + event.getPacket());
                }
        );
        eventNode.addListener(
                PlayerPacketOutEvent.class,
                playerPacketOutEvent -> {
                    Logger.info("Packet sent " + playerPacketOutEvent.getPacket());
                }
        );

        eventNode.addListener(PlayerMoveEvent.class, event -> {
            Player player = event.getPlayer();
            Point pos = player.getPosition();
            Vec vel = player.getVelocity();

            double currentX = pos.x();
            double currentY = pos.y();
            double currentZ = pos.z();
            double velocityX = vel.x();
            double velocityY = vel.y();
            double velocityZ = vel.z();

            Point newPos = event.getNewPosition();

            double dx = newPos.x() - currentX;
            double dy = newPos.y() - currentY;
            double dz = newPos.z() - currentZ;

            double actualDisplacement = dx * dx + dy * dy + dz * dz;
            double expectedDisplacement = velocityX * velocityX + velocityY * velocityY + velocityZ * velocityZ;

            float upperLimit = 100; // TODO: 300 if elytra deployed

            if (actualDisplacement - expectedDisplacement >= upperLimit) {
                event.setCancelled(true);
                player.teleport(player.getPosition()); // force teleport to previous position
                Logger.warn(player.getUsername() + " moved too fast! " + dx + " " + dy + " " + dz);
            }
        });

        eventNode.addListener(
                EventListener.builder(PlayerSpawnEvent.class)
                        .filter(PlayerSpawnEvent::isFirstSpawn)
                        .handler(event -> {
                            Player player = event.getPlayer();

                            player.setPermissionLevel(4);
                            player.setGameMode(GameMode.CREATIVE);

                            player.getInstance().loadChunk(player.getPosition()).join();

                            int y = player.getInstance().getDimensionType().getMaxY();
                            while (player.getInstance().getBlock(1, y, 1).isAir()) {
                                y--;
                            }

                            player.teleport(new Pos(1, y + 1, 1));
                            PlayerInventory inventory = player.getInventory();

                            inventory.addItemStack(ItemStack.of(Material.OBSIDIAN, 1));
                            inventory.addItemStack(ItemStack.of(Material.FLINT_AND_STEEL, 1));
                            inventory.addItemStack(ItemStack.of(Material.RED_BED, 1));
                            inventory.addItemStack(ItemStack.of(Material.CHEST, 1));
                            inventory.addItemStack(ItemStack.of(Material.CRAFTING_TABLE, 1));
                            inventory.addItemStack(ItemStack.of(Material.OAK_LOG, 32));
                            inventory.addItemStack(ItemStack.of(Material.STONECUTTER, 1));
                            inventory.addItemStack(ItemStack.of(Material.STONE, 64));

                        })
                        .build()
        );

        eventNode.addListener(
                EventListener.builder(PickupItemEvent.class)
                        .filter(event -> event.getEntity() instanceof Player)
                        .handler(event -> {
                            Player player = (Player) event.getEntity();
                            boolean couldAdd = player.getInventory().addItemStack(event.getItemStack());
                            event.setCancelled(!couldAdd); // Cancel event if player does not have enough inventory space
                        })
                        .build()
        );

        eventNode.addListener(ItemDropEvent.class, event -> {
            Player player = event.getPlayer();
            ItemStack droppedItem = event.getItemStack();

            ItemEntity itemEntity = new ItemEntity(droppedItem);
            itemEntity.setPickupDelay(500, TimeUnit.MILLISECOND);
            itemEntity.setInstance(player.getInstance());
            itemEntity.teleport(player.getPosition().add(0, 1.5f, 0));

            Vec velocity = player.getPosition().direction().mul(6);
            itemEntity.setVelocity(velocity);
        });
    }
}
